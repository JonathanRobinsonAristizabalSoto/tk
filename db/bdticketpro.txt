-- Eliminar la base de datos si existe
DROP DATABASE IF EXISTS ticketpro;

-- Crear la base de datos
CREATE DATABASE IF NOT EXISTS ticketpro;
USE ticketpro;

-- Estructura de tabla para la tabla roles
CREATE TABLE roles (
    id_rol INT PRIMARY KEY AUTO_INCREMENT,
    nombre ENUM('Administrador', 'Soporte', 'Usuario') NOT NULL UNIQUE,
    descripcion TEXT,
    estado ENUM('Activo', 'Inactivo') NOT NULL DEFAULT 'Activo',
    eliminado BOOLEAN NOT NULL DEFAULT 0,
    fecha_creacion DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    fecha_actualizacion DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- Estructura de tabla para la tabla permisos
CREATE TABLE permisos (
    id_permiso INT PRIMARY KEY AUTO_INCREMENT,
    nombre VARCHAR(255) NOT NULL UNIQUE,
    descripcion TEXT,
    eliminado BOOLEAN NOT NULL DEFAULT 0,
    fecha_creacion DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    fecha_actualizacion DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- Estructura de tabla intermedia rolpermisos
CREATE TABLE rolpermisos (
    id_rol INT,
    id_permiso INT,
    fecha_asignacion DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    eliminado BOOLEAN NOT NULL DEFAULT 0,
    PRIMARY KEY (id_rol, id_permiso),
    FOREIGN KEY (id_rol) REFERENCES roles(id_rol),
    FOREIGN KEY (id_permiso) REFERENCES permisos(id_permiso)
);

-- Estructura de tabla para la tabla usuarios
CREATE TABLE usuarios (
    id_usuario INT AUTO_INCREMENT PRIMARY KEY,
    tipo_documento ENUM('CC', 'TI', 'CE', 'PS', 'DNI', 'NIT') NOT NULL,
    documento VARCHAR(255) NOT NULL UNIQUE,
    nombre VARCHAR(255) NOT NULL,
    apellido VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL UNIQUE,
    telefono VARCHAR(20),
    departamento VARCHAR(255),
    municipio VARCHAR(255),
    foto VARCHAR(255), -- Ruta de la imagen de perfil
    password VARCHAR(255) NOT NULL,
    id_rol INT NOT NULL,
    estado ENUM('Activo', 'Inactivo') NOT NULL DEFAULT 'Activo',
    email_verificado BOOLEAN NOT NULL DEFAULT 0,
    token_verificacion VARCHAR(255),
    eliminado BOOLEAN NOT NULL DEFAULT 0,
    fecha_registro DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    fecha_actualizacion DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX (email),
    INDEX (documento),
    FOREIGN KEY (id_rol) REFERENCES roles(id_rol)
);

-- Estructura de tabla para la tabla tipologias
CREATE TABLE tipologias (
    id_tipologia INT AUTO_INCREMENT PRIMARY KEY,
    tipologia ENUM('Formacion', 'Consultas', 'Certificacion', 'PQRSF', 'Otro') NOT NULL,
    subtipologia VARCHAR(255) NOT NULL,
    id_rol INT,
    estado_tipologia ENUM('Activo', 'Inactivo') NOT NULL DEFAULT 'Activo',
    eliminado BOOLEAN NOT NULL DEFAULT 0,
    fecha_creacion DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    fecha_actualizacion DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX (subtipologia),
    FOREIGN KEY (id_rol) REFERENCES roles(id_rol)
);

-- Estructura de tabla para la tabla programas
CREATE TABLE programas (
    id_programa INT AUTO_INCREMENT PRIMARY KEY,
    codigo VARCHAR(50) NOT NULL,
    version VARCHAR(50) NOT NULL,
    nombre VARCHAR(255) NOT NULL UNIQUE,
    descripcion TEXT,
    duracion INT NOT NULL,
    linea_tecnologica VARCHAR(255) NOT NULL,
    red_tecnologica VARCHAR(255) NOT NULL,
    red_de_conocimiento VARCHAR(255) NOT NULL,
    modalidad VARCHAR(255) NOT NULL,
    id_tipologia INT NOT NULL,
    estado ENUM('Activo', 'Inactivo') NOT NULL DEFAULT 'Activo',
    eliminado BOOLEAN NOT NULL DEFAULT 0,
    fecha_creacion DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    fecha_actualizacion DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (id_tipologia) REFERENCES tipologias(id_tipologia)
);

-- Estructura de tabla para la tabla ticket
CREATE TABLE ticket (
    id_ticket INT AUTO_INCREMENT PRIMARY KEY,
    id_usuario INT NOT NULL,
    numero_ticket VARCHAR(50) NOT NULL,
    descripcion TEXT NOT NULL,
    prioridad ENUM('Alta', 'Media', 'Baja') NOT NULL,
    estado ENUM('Abierto', 'Progreso', 'Pendiente', 'Resuelto', 'Cerrado') NOT NULL,
    id_rol INT,
    id_programa INT,
    id_tipologia INT,
    eliminado BOOLEAN NOT NULL DEFAULT 0,
    fecha_creacion DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    fecha_actualizacion DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario),
    FOREIGN KEY (id_rol) REFERENCES roles(id_rol),
    FOREIGN KEY (id_programa) REFERENCES programas(id_programa),
    FOREIGN KEY (id_tipologia) REFERENCES tipologias(id_tipologia)
);

-- Historial de estados de ticket
CREATE TABLE ticket_estado_historial (
    id_historial INT AUTO_INCREMENT PRIMARY KEY,
    id_ticket INT NOT NULL,
    estado_anterior ENUM('Abierto', 'Progreso', 'Pendiente', 'Resuelto', 'Cerrado'),
    estado_nuevo ENUM('Abierto', 'Progreso', 'Pendiente', 'Resuelto', 'Cerrado'),
    fecha_cambio DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    id_usuario INT,
    eliminado BOOLEAN NOT NULL DEFAULT 0,
    FOREIGN KEY (id_ticket) REFERENCES ticket(id_ticket),
    FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario)
);

-- Estructura de tabla para la tabla comentario
CREATE TABLE comentario (
    id_comentario INT PRIMARY KEY AUTO_INCREMENT,
    id_ticket INT,
    id_usuario INT,
    comentario TEXT NOT NULL,
    prioridad ENUM('Alta', 'Media', 'Baja'),
    categoria VARCHAR(255),
    eliminado BOOLEAN NOT NULL DEFAULT 0,
    fecha_creacion DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    fecha_actualizacion DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX (id_ticket),
    INDEX (id_usuario),
    FOREIGN KEY (id_ticket) REFERENCES ticket(id_ticket),
    FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario)
);

-- Estructura de tabla para la tabla evento
CREATE TABLE evento (
    id_evento INT PRIMARY KEY AUTO_INCREMENT,
    id_ticket INT,
    accion VARCHAR(255) NOT NULL,
    id_usuario INT,
    categoria VARCHAR(255),
    eliminado BOOLEAN NOT NULL DEFAULT 0,
    fecha_evento DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    fecha_actualizacion DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX (id_ticket),
    INDEX (id_usuario),
    FOREIGN KEY (id_ticket) REFERENCES ticket(id_ticket),
    FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario)
);

-- Tabla de adjuntos
CREATE TABLE adjuntos (
    id_adjunto INT PRIMARY KEY AUTO_INCREMENT,
    id_ticket INT,
    id_comentario INT,
    nombre_archivo VARCHAR(255) NOT NULL,
    ruta_archivo VARCHAR(255) NOT NULL,
    tipo_archivo VARCHAR(50),
    eliminado BOOLEAN NOT NULL DEFAULT 0,
    fecha_subida DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (id_ticket) REFERENCES ticket(id_ticket),
    FOREIGN KEY (id_comentario) REFERENCES comentario(id_comentario)
);

-- Tabla de notificaciones
CREATE TABLE notificaciones (
    id_notificacion INT PRIMARY KEY AUTO_INCREMENT,
    id_usuario INT NOT NULL,
    mensaje TEXT NOT NULL,
    leido BOOLEAN NOT NULL DEFAULT 0,
    eliminado BOOLEAN NOT NULL DEFAULT 0,
    fecha_creacion DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    fecha_actualizacion DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario)
);

-- Tabla de auditoría
CREATE TABLE auditoria (
    id_auditoria INT PRIMARY KEY AUTO_INCREMENT,
    id_usuario INT,
    accion VARCHAR(255) NOT NULL,
    descripcion TEXT,
    eliminado BOOLEAN NOT NULL DEFAULT 0,
    fecha DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario)
);

-- Tabla de restablecimiento de contraseña
CREATE TABLE password_reset (
    id_reset INT PRIMARY KEY AUTO_INCREMENT,
    id_usuario INT NOT NULL,
    token VARCHAR(255) NOT NULL,
    expiracion DATETIME NOT NULL,
    usado BOOLEAN NOT NULL DEFAULT 0,
    eliminado BOOLEAN NOT NULL DEFAULT 0,
    fecha_creacion DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario)
);

-- Tabla de asignación de tickets a responsables
CREATE TABLE ticket_asignacion (
    id_asignacion INT PRIMARY KEY AUTO_INCREMENT,
    id_ticket INT NOT NULL,
    id_usuario INT NOT NULL,
    fecha_asignacion DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    eliminado BOOLEAN NOT NULL DEFAULT 0,
    FOREIGN KEY (id_ticket) REFERENCES ticket(id_ticket),
    FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario)
);

-- Tabla de logs de acceso
CREATE TABLE acceso_log (
    id_log INT PRIMARY KEY AUTO_INCREMENT,
    id_usuario INT NOT NULL,
    tipo VARCHAR(20) NOT NULL, -- 'login' o 'logout'
    fecha DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ip VARCHAR(45),
    eliminado BOOLEAN NOT NULL DEFAULT 0,
    FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario)
);

-- Volcado de datos para la tabla roles
INSERT INTO roles (nombre, descripcion, estado, fecha_creacion) VALUES
('Administrador', 'Acceso completo al sistema.', 'Activo', '2023-10-01 10:00:00'),
('Soporte', 'Resuelve tickets y asistencia técnica.', 'Activo', '2023-10-01 10:00:00'),
('Usuario', 'Crea tickets y realiza solicitudes.', 'Activo', '2023-10-01 10:00:00');

-- Volcado de datos para la tabla permisos
INSERT INTO permisos (nombre, descripcion, fecha_creacion) VALUES
('Crear', 'Permiso para crear usuarios tipolgias programas tickets y comentarios en el sistema.', '2023-10-01 10:00:00'),
('Ver', 'Permiso para visualizar usuarios tipolgias programas tickets y comentarios', '2023-10-01 10:00:00'),
('Editar', 'Permiso para editar los detalles de un usuario tipolgia programa ticket y comentario', '2023-10-01 10:00:00'),
('Eliminar', 'Permiso para eliminar una tipolgia programa ticket y comentario.', '2023-10-01 10:00:00'),
('Activar', 'Permiso para activar un usuario tipolgia o programa.', '2023-10-01 10:00:00'),
('Desactivar', 'Permiso para desactivar un usuario tipolgia o programa.', '2023-10-01 10:00:00');

-- Asignación de permisos a los roles en la tabla intermedia rolpermisos
INSERT INTO rolpermisos (id_rol, id_permiso, fecha_asignacion) VALUES
(1, 1, '2023-10-01 10:00:00'), -- Administrador: Crear
(1, 2, '2023-10-01 10:00:00'), -- Administrador: Ver
(1, 3, '2023-10-01 10:00:00'), -- Administrador: Editar
(1, 4, '2023-10-01 10:00:00'), -- Administrador: Eliminar
(1, 5, '2023-10-01 10:00:00'), -- Administrador: Activar
(1, 6, '2023-10-01 10:00:00'), -- Administrador: Desactivar
(2, 2, '2023-10-01 10:00:00'), -- Soporte: Ver
(2, 3, '2023-10-01 10:00:00'), -- Soporte: Editar
(3, 1, '2023-10-01 10:00:00'), -- Usuario: Crear
(3, 2, '2023-10-01 10:00:00'); -- Usuario: Ver

INSERT INTO usuarios (
    tipo_documento, documento, nombre, apellido, email, telefono, departamento, municipio, foto, password, id_rol, estado, email_verificado, eliminado
) VALUES
('CC', '1053810807', 'Jonathan', 'Aristizabal', 'admin@gmail.com', '3187542709', 'Caldas', 'Manizales', 'assets/images/perfiles/default.png', '$2y$10$JA/SnuV36zc/jbkkH4Wwje7F1HGm5Le7ZQd0AMzrTGk3lBPaUIzLi', 1, 'Activo', 1, 0), -- Administrador
('CC', '1000000002', 'Jaime', 'Rodriguez', 'jaime@email.com', '3100000002', 'Caldas', 'Manizales', 'assets/images/perfiles/default.png', '$2y$10$JA/SnuV36zc/jbkkH4Wwje7F1HGm5Le7ZQd0AMzrTGk3lBPaUIzLi', 2, 'Activo', 1, 0), -- Soporte
('CC', '1000000003', 'Gloria', 'Corrales', 'gloria@email.com', '3100000003', 'Caldas', 'Manizales', 'assets/images/perfiles/default.png', '$2y$10$JA/SnuV36zc/jbkkH4Wwje7F1HGm5Le7ZQd0AMzrTGk3lBPaUIzLi', 2, 'Activo', 1, 0), -- Soporte
('CC', '1000000004', 'Sofía', 'Ramírez', 'sofia@email.com', '3100000004', 'Caldas', 'Manizales', 'assets/images/perfiles/default.png', '$2y$10$JA/SnuV36zc/jbkkH4Wwje7F1HGm5Le7ZQd0AMzrTGk3lBPaUIzLi', 3, 'Activo', 1, 0),
('CC', '1000000005', 'Carlos', 'López', 'carlos@email.com', '3100000005', 'Caldas', 'Manizales', 'assets/images/perfiles/default.png', '$2y$10$JA/SnuV36zc/jbkkH4Wwje7F1HGm5Le7ZQd0AMzrTGk3lBPaUIzLi', 3, 'Activo', 1, 0),
('CC', '1000000006', 'María', 'Torres', 'maria@email.com', '3100000006', 'Caldas', 'Manizales', 'assets/images/perfiles/default.png', '$2y$10$JA/SnuV36zc/jbkkH4Wwje7F1HGm5Le7ZQd0AMzrTGk3lBPaUIzLi', 3, 'Activo', 1, 0),
('CC', '1000000007', 'Pedro', 'García', 'pedro@email.com', '3100000007', 'Caldas', 'Manizales', 'assets/images/perfiles/default.png', '$2y$10$JA/SnuV36zc/jbkkH4Wwje7F1HGm5Le7ZQd0AMzrTGk3lBPaUIzLi', 3, 'Activo', 1, 0),
('CC', '1000000008', 'Laura', 'Jiménez', 'laura@email.com', '3100000008', 'Caldas', 'Manizales', 'assets/images/perfiles/default.png', '$2y$10$JA/SnuV36zc/jbkkH4Wwje7F1HGm5Le7ZQd0AMzrTGk3lBPaUIzLi', 3, 'Activo', 1, 0),
('CC', '1000000009', 'Diego', 'Castro', 'diego@email.com', '3100000009', 'Caldas', 'Manizales', 'assets/images/perfiles/default.png', '$2y$10$JA/SnuV36zc/jbkkH4Wwje7F1HGm5Le7ZQd0AMzrTGk3lBPaUIzLi', 3, 'Activo', 1, 0),
('CC', '1000000010', 'Valentina', 'Mendoza', 'valentina@email.com', '3100000010', 'Caldas', 'Manizales', 'assets/images/perfiles/default.png', '$2y$10$JA/SnuV36zc/jbkkH4Wwje7F1HGm5Le7ZQd0AMzrTGk3lBPaUIzLi', 3, 'Activo', 1, 0),
('CC', '1000000011', 'Miguel', 'Suárez', 'miguel@email.com', '3100000011', 'Caldas', 'Manizales', 'assets/images/perfiles/default.png', '$2y$10$JA/SnuV36zc/jbkkH4Wwje7F1HGm5Le7ZQd0AMzrTGk3lBPaUIzLi', 3, 'Activo', 1, 0),
('CC', '1000000012', 'Camila', 'Moreno', 'camila@email.com', '3100000012', 'Caldas', 'Manizales', 'assets/images/perfiles/default.png', '$2y$10$JA/SnuV36zc/jbkkH4Wwje7F1HGm5Le7ZQd0AMzrTGk3lBPaUIzLi', 3, 'Activo', 1, 0),
('CC', '1000000013', 'Andrés', 'Ríos', 'andres@email.com', '3100000013', 'Caldas', 'Manizales', 'assets/images/perfiles/default.png', '$2y$10$JA/SnuV36zc/jbkkH4Wwje7F1HGm5Le7ZQd0AMzrTGk3lBPaUIzLi', 3, 'Activo', 1, 0),
('CC', '1000000014', 'Paula', 'Vargas', 'paula@email.com', '3100000014', 'Caldas', 'Manizales', 'assets/images/perfiles/default.png', '$2y$10$JA/SnuV36zc/jbkkH4Wwje7F1HGm5Le7ZQd0AMzrTGk3lBPaUIzLi', 3, 'Activo', 1, 0),
('CC', '1000000015', 'Jorge', 'Castaño', 'jorge@email.com', '3100000015', 'Caldas', 'Manizales', 'assets/images/perfiles/default.png', '$2y$10$JA/SnuV36zc/jbkkH4Wwje7F1HGm5Le7ZQd0AMzrTGk3lBPaUIzLi', 3, 'Activo', 1, 0),
('CC', '1000000016', 'Sara', 'Ortiz', 'sara@email.com', '3100000016', 'Caldas', 'Manizales', 'assets/images/perfiles/default.png', '$2y$10$JA/SnuV36zc/jbkkH4Wwje7F1HGm5Le7ZQd0AMzrTGk3lBPaUIzLi', 3, 'Activo', 1, 0),
('CC', '1000000017', 'Felipe', 'Navarro', 'felipe@email.com', '3100000017', 'Caldas', 'Manizales', 'assets/images/perfiles/default.png', '$2y$10$JA/SnuV36zc/jbkkH4Wwje7F1HGm5Le7ZQd0AMzrTGk3lBPaUIzLi', 3, 'Activo', 1, 0),
('CC', '1000000018', 'Isabella', 'Cruz', 'isabella@email.com', '3100000018', 'Caldas', 'Manizales', 'assets/images/perfiles/default.png', '$2y$10$JA/SnuV36zc/jbkkH4Wwje7F1HGm5Le7ZQd0AMzrTGk3lBPaUIzLi', 3, 'Activo', 1, 0),
('CC', '1000000019', 'David', 'Santos', 'david@email.com', '3100000019', 'Caldas', 'Manizales', 'assets/images/perfiles/default.png', '$2y$10$JA/SnuV36zc/jbkkH4Wwje7F1HGm5Le7ZQd0AMzrTGk3lBPaUIzLi', 3, 'Activo', 1, 0),
('CC', '1000000020', 'Lucía', 'Mejía', 'lucia@email.com', '3100000020', 'Caldas', 'Manizales', 'assets/images/perfiles/default.png', '$2y$10$JA/SnuV36zc/jbkkH4Wwje7F1HGm5Le7ZQd0AMzrTGk3lBPaUIzLi', 3, 'Activo', 1, 0);